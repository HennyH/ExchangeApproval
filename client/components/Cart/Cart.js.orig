import m from 'mithril'

import DataTable from 'Components/DataTable'
import {
    COLUMN_NAMES as DECISION_TABLE_COLUMN_NAMES,
    makeDecisionsTableConfig,
    default as DecisionsTable
} from 'Components/SearchPage/DecisionsTable.js'
import {CartData as CART} from '../ViewData.js'

export const CART_EVENTS = {
    CART_CHANGED: 'CART_CHANGED'
};

export function makeCartTableConfig(cartItems) {
    const decisionsTableConfig = makeDecisionsTableConfig(cartItems);
    const columnsToKeep = [
        DECISION_TABLE_COLUMN_NAMES.Type,
        DECISION_TABLE_COLUMN_NAMES.ExchangeUniversity,
        DECISION_TABLE_COLUMN_NAMES.ExchangeUnit,
        DECISION_TABLE_COLUMN_NAMES.UWAUnit
    ];
    return {
        ...decisionsTableConfig,
        columns: [
            ...decisionsTableConfig.columns.filter(c => columnsToKeep.includes(c.title)),
            {
                title: 'Remove from Cart',
                data: null,
                defaultContent: "<button type='button' class='btn btn-primary'>üóëÔ∏è</button>"
            }
        ]
    }
}

export function getItemsInCart() {
    return [...CART.items];
}

export function emitCartEvent(name, ...args) {
    if (name === CART_EVENTS.CART_CHANGED) {
        args = [CART.items, ...args]
    }

    for (let handler of CART.handlers) {
        if (handler.name === name) {
            handler.func(...args);
        }
    }

    m.redraw();
}

export function addItemToCart(item, emitEvent = true) {
    /* Avoid adding duplicates to a cart by removing any previous copies
     * of the item.
     */
    removeItemFromCart(item, false);
    CART.items = [item, ...CART.items];
    if (emitEvent) {
        emitCartEvent(CART_EVENTS.CART_CHANGED);
    }
}

export function removeItemFromCart(item, emitEvent = true) {
    CART.items = CART.items.filter(i => i !== item);
    if (emitEvent) {
        emitCartEvent(CART_EVENTS.CART_CHANGED);
    }
}

export function isItemInCart(item) {
    return CART.items.indexOf(item) >= 0;
}

export function addCartEventHandler(name, id, callback) {
    CART.handlers.push({
        name,
        id,
        func: callback
    });
}

export function removeCartEventHandler(name, id, callback) {
    const index = CART.handlers.find(
        h => h.name === name && (h.callback === callback || h.id === id)
    );
    if (index >= 0) {
        CART.handlers.splice(index, 1);
    }
}

export default function Cart() {

    function view() {
        return (
<<<<<<< HEAD
            <div>
                {window.CART.items.length === 0 ? <h6>Cart is empty.</h6> : <div />}
                <DataTable
                    config={makeCartTableConfig(window.CART.items)}
                    setup={(id, datatable) => {
                        $(`#${id} tbody`).on('click', 'button', function(event) {
                            const item = datatable.row($(event.target).parents('tr')).data();
                            removeItemFromCart(item);
                        });
                        $(`#${id} tbody`).tooltip({
                            selector: '[rel="popover"]',
                            trigger: 'hover'
                        });
                    }}
                />
            </div>
=======
			<div class="card bg-light my-3">
				<div class="card-header d-flex align-items-center">Cart</div>
				<div class="card-body">
					{CART.items.length === 0 ? <h6>Cart is empty.</h6> : ''}
					<DataTable
						config={makeCartTableConfig(CART.items)}
						setup={(id, datatable) => {
							$(`#${id} tbody`).on('click', 'button', function(event) {
								const item = datatable.row($(event.target).parents('tr')).data();
								removeItemFromCart(item);
							});
							$(`#${id} tbody`).tooltip({
								selector: '[rel="popover"]',
								trigger: 'hover'
							});
						}}
					/>
				</div>
				<div class="card-footer">
					<button class="btn btn-primary float-right ml-auto" oncreate={m.route.link} href="/application" disabled={CART.items.length === 0}>
							<span class="ml-2">Go to Application
								<span class="badge badge-secondary mx-2">{CART.items.length}</span>
							</span>
					</button>
				</div>
			</div>
>>>>>>> 16380d2... Added ViewData module. Added clipboard and send email buttons
        );
    }

    return { view };
}